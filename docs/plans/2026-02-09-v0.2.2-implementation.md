# BotDrop v0.2.2 Features Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Add manual update button, dynamic model selector, and config template caching to improve UX.

**Architecture:** Three independent components - ConfigTemplateCache (SharedPreferences storage), ModelSelectorDialog (reusable dialog with search), and manual update button (SetupActivity navigation bar). Components integrate into existing Auth and Dashboard flows without breaking changes.

**Tech Stack:** Android Java, SharedPreferences, RecyclerView, BotDropService for command execution.

---

## Prerequisites

**Required files exist:**
- `app/src/main/java/app/botdrop/BotDropService.java`
- `app/src/main/java/app/botdrop/BotDropConfig.java`
- `app/src/main/java/app/botdrop/UpdateChecker.java`
- `app/src/main/java/app/botdrop/AuthFragment.java`
- `app/src/main/java/app/botdrop/DashboardActivity.java`
- `app/src/main/java/app/botdrop/SetupActivity.java`
- `app/src/main/res/layout/activity_botdrop_setup.xml`
- `app/src/main/res/layout/activity_botdrop_dashboard.xml`

**Dependencies:**
- Task dependencies are marked with "Depends on: Task X"
- Test and commit after each task
- Follow TDD where applicable

---

## Task 1: Create ConfigTemplate Data Class

**Files:**
- Create: `app/src/main/java/app/botdrop/ConfigTemplate.java`

**Goal:** Simple data class to hold configuration template fields.

### Step 1: Create ConfigTemplate.java

Create the file with complete implementation:

```java
package app.botdrop;

/**
 * Configuration template data class.
 * Holds user configuration for caching and quick recovery.
 */
public class ConfigTemplate {

    public String provider;      // e.g., "google"
    public String model;         // e.g., "gemini-3-flash-preview"
    public String apiKey;        // e.g., "AIzaSy..."
    public String tgBotToken;    // e.g., "7123456:AAF..." (optional)
    public String tgUserId;      // e.g., "987654321" (optional)

    public ConfigTemplate() {
    }

    public ConfigTemplate(String provider, String model, String apiKey) {
        this.provider = provider;
        this.model = model;
        this.apiKey = apiKey;
    }

    /**
     * Validate that required fields are present.
     * @return true if provider, model, and apiKey are non-empty
     */
    public boolean isValid() {
        return provider != null && !provider.isEmpty()
            && model != null && !model.isEmpty()
            && apiKey != null && !apiKey.isEmpty();
        // tgBotToken and tgUserId are optional
    }

    @Override
    public String toString() {
        return "ConfigTemplate{" +
            "provider='" + provider + '\'' +
            ", model='" + model + '\'' +
            ", apiKey='***'" + // Don't log full key
            ", tgBotToken=" + (tgBotToken != null ? "***" : "null") +
            ", tgUserId='" + tgUserId + '\'' +
            '}';
    }
}
```

### Step 2: Build to verify no syntax errors

Run: `./gradlew :app:compileDebugJavaWithJavac`
Expected: SUCCESS

### Step 3: Commit

```bash
git add app/src/main/java/app/botdrop/ConfigTemplate.java
git commit -m "feat: add ConfigTemplate data class for config caching"
```

---

## Task 2: Create ConfigTemplateCache

**Files:**
- Create: `app/src/main/java/app/botdrop/ConfigTemplateCache.java`

**Goal:** SharedPreferences-based cache for configuration templates.

### Step 1: Create ConfigTemplateCache.java

Create the file with complete implementation:

```java
package app.botdrop;

import android.content.Context;
import android.content.SharedPreferences;

import com.termux.shared.logger.Logger;

/**
 * Configuration template cache using SharedPreferences.
 * Purpose: Avoid users re-entering configuration information.
 * Not for security - just convenience caching.
 */
public class ConfigTemplateCache {

    private static final String LOG_TAG = "ConfigTemplateCache";
    private static final String PREFS_NAME = "botdrop_config_template";
    private static final int CONFIG_VERSION = 1;

    // Keys
    private static final String KEY_VERSION = "version";
    private static final String KEY_PROVIDER = "provider";
    private static final String KEY_MODEL = "model";
    private static final String KEY_API_KEY = "api_key";
    private static final String KEY_TG_BOT_TOKEN = "tg_bot_token";
    private static final String KEY_TG_USER_ID = "tg_user_id";

    /**
     * Save configuration template to cache.
     */
    public static void saveTemplate(Context ctx, ConfigTemplate template) {
        if (template == null) {
            Logger.logError(LOG_TAG, "Cannot save null template");
            return;
        }

        try {
            SharedPreferences prefs = ctx.getSharedPreferences(PREFS_NAME, Context.MODE_PRIVATE);
            SharedPreferences.Editor editor = prefs.edit();

            editor.putInt(KEY_VERSION, CONFIG_VERSION);
            editor.putString(KEY_PROVIDER, template.provider);
            editor.putString(KEY_MODEL, template.model);
            editor.putString(KEY_API_KEY, template.apiKey);
            editor.putString(KEY_TG_BOT_TOKEN, template.tgBotToken);
            editor.putString(KEY_TG_USER_ID, template.tgUserId);

            editor.apply();
            Logger.logInfo(LOG_TAG, "Config template saved: " + template.toString());

        } catch (Exception e) {
            Logger.logError(LOG_TAG, "Failed to save template: " + e.getMessage());
        }
    }

    /**
     * Load configuration template from cache.
     * @return ConfigTemplate or null if not found or invalid
     */
    public static ConfigTemplate loadTemplate(Context ctx) {
        try {
            SharedPreferences prefs = ctx.getSharedPreferences(PREFS_NAME, Context.MODE_PRIVATE);

            // Check version
            int version = prefs.getInt(KEY_VERSION, 0);
            if (version == 0) {
                Logger.logDebug(LOG_TAG, "No config template found");
                return null;
            }

            if (version < CONFIG_VERSION) {
                Logger.logInfo(LOG_TAG, "Config version outdated, migrating...");
                // Future: add migration logic here
            }

            ConfigTemplate template = new ConfigTemplate();
            template.provider = prefs.getString(KEY_PROVIDER, null);
            template.model = prefs.getString(KEY_MODEL, null);
            template.apiKey = prefs.getString(KEY_API_KEY, null);
            template.tgBotToken = prefs.getString(KEY_TG_BOT_TOKEN, null);
            template.tgUserId = prefs.getString(KEY_TG_USER_ID, null);

            Logger.logInfo(LOG_TAG, "Config template loaded: " + template.toString());
            return template;

        } catch (Exception e) {
            Logger.logError(LOG_TAG, "Failed to load template: " + e.getMessage());
            clearTemplate(ctx); // Clear corrupted data
            return null;
        }
    }

    /**
     * Check if a configuration template exists in cache.
     */
    public static boolean hasTemplate(Context ctx) {
        try {
            SharedPreferences prefs = ctx.getSharedPreferences(PREFS_NAME, Context.MODE_PRIVATE);
            int version = prefs.getInt(KEY_VERSION, 0);
            return version > 0;
        } catch (Exception e) {
            Logger.logError(LOG_TAG, "Failed to check template: " + e.getMessage());
            return false;
        }
    }

    /**
     * Clear configuration template from cache.
     */
    public static void clearTemplate(Context ctx) {
        try {
            SharedPreferences prefs = ctx.getSharedPreferences(PREFS_NAME, Context.MODE_PRIVATE);
            prefs.edit().clear().apply();
            Logger.logInfo(LOG_TAG, "Config template cleared");
        } catch (Exception e) {
            Logger.logError(LOG_TAG, "Failed to clear template: " + e.getMessage());
        }
    }

    /**
     * Apply template to OpenClaw configuration files.
     * @return true if successful
     */
    public static boolean applyTemplate(Context ctx, ConfigTemplate template) {
        if (template == null || !template.isValid()) {
            Logger.logError(LOG_TAG, "Cannot apply invalid template");
            return false;
        }

        try {
            // Set provider and model
            boolean success = BotDropConfig.setProvider(template.provider, template.model);
            if (!success) {
                Logger.logError(LOG_TAG, "Failed to set provider/model");
                return false;
            }

            // Set API key
            success = BotDropConfig.setApiKey(template.provider, template.apiKey);
            if (!success) {
                Logger.logError(LOG_TAG, "Failed to set API key");
                return false;
            }

            // Set Telegram config if present
            if (template.tgBotToken != null && !template.tgBotToken.isEmpty()) {
                success = BotDropConfig.setTelegramChannel(template.tgBotToken, template.tgUserId);
                if (!success) {
                    Logger.logError(LOG_TAG, "Failed to set Telegram config");
                    return false;
                }
            }

            Logger.logInfo(LOG_TAG, "Config template applied successfully");
            return true;

        } catch (Exception e) {
            Logger.logError(LOG_TAG, "Failed to apply template: " + e.getMessage());
            return false;
        }
    }
}
```

### Step 2: Build to verify no syntax errors

Run: `./gradlew :app:compileDebugJavaWithJavac`
Expected: SUCCESS

### Step 3: Commit

```bash
git add app/src/main/java/app/botdrop/ConfigTemplateCache.java
git commit -m "feat: add ConfigTemplateCache for SharedPreferences-based config caching"
```

---

## Task 3: Create ModelInfo Data Class

**Files:**
- Create: `app/src/main/java/app/botdrop/ModelInfo.java`

**Goal:** Data class to hold parsed model information from `openclaw models list`.

### Step 1: Create ModelInfo.java

```java
package app.botdrop;

/**
 * Model information parsed from openclaw models list.
 */
public class ModelInfo {

    public String fullName;     // "google/gemini-3-flash-preview"
    public String provider;     // "google"
    public String model;        // "gemini-3-flash-preview"
    public String input;        // "text+image"
    public String context;      // "1024k"
    public boolean isDefault;   // has "default" tag

    public ModelInfo(String fullName) {
        this.fullName = fullName;

        // Parse provider and model from fullName
        if (fullName != null && fullName.contains("/")) {
            String[] parts = fullName.split("/", 2);
            this.provider = parts[0];
            this.model = parts[1];
        }
    }

    public ModelInfo(String fullName, String provider, String model) {
        this.fullName = fullName;
        this.provider = provider;
        this.model = model;
    }

    @Override
    public String toString() {
        return fullName;
    }
}
```

### Step 2: Build to verify

Run: `./gradlew :app:compileDebugJavaWithJavac`
Expected: SUCCESS

### Step 3: Commit

```bash
git add app/src/main/java/app/botdrop/ModelInfo.java
git commit -m "feat: add ModelInfo data class for model list parsing"
```

---

## Task 4: Create ModelSelectorDialog Layout

**Files:**
- Create: `app/src/main/res/layout/dialog_model_selector.xml`

**Goal:** Dialog UI with search box and RecyclerView.

### Step 1: Create dialog_model_selector.xml

```xml
<?xml version="1.0" encoding="utf-8"?>
<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    android:layout_width="match_parent"
    android:layout_height="wrap_content"
    android:orientation="vertical"
    android:padding="24dp"
    android:background="@color/botdrop_background">

    <!-- Title -->
    <TextView
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:text="Select Model"
        android:textSize="20sp"
        android:textColor="@color/botdrop_primary_text"
        android:fontFamily="sans-serif-medium"
        android:layout_marginBottom="16dp" />

    <!-- Search box -->
    <EditText
        android:id="@+id/model_search"
        android:layout_width="match_parent"
        android:layout_height="48dp"
        android:hint="Search models..."
        android:textColor="@color/botdrop_primary_text"
        android:textColorHint="@color/botdrop_secondary_text"
        android:background="@drawable/edit_text_background"
        android:paddingStart="12dp"
        android:paddingEnd="12dp"
        android:imeOptions="actionSearch"
        android:inputType="text"
        android:layout_marginBottom="16dp" />

    <!-- Model list -->
    <androidx.recyclerview.widget.RecyclerView
        android:id="@+id/model_list"
        android:layout_width="match_parent"
        android:layout_height="300dp"
        android:visibility="gone" />

    <!-- Status message -->
    <TextView
        android:id="@+id/model_status"
        android:layout_width="match_parent"
        android:layout_height="300dp"
        android:text="Loading models..."
        android:textColor="@color/botdrop_secondary_text"
        android:gravity="center"
        android:visibility="visible" />

    <!-- Retry button -->
    <Button
        android:id="@+id/model_retry"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:text="Retry"
        android:layout_gravity="center"
        android:visibility="gone"
        android:background="@drawable/botdrop_button_bg"
        android:textColor="@color/botdrop_background"
        android:paddingStart="24dp"
        android:paddingEnd="24dp"
        android:layout_marginTop="8dp" />

</LinearLayout>
```

### Step 2: Create model list item layout

Create: `app/src/main/res/layout/item_model.xml`

```xml
<?xml version="1.0" encoding="utf-8"?>
<TextView xmlns:android="http://schemas.android.com/apk/res/android"
    android:id="@+id/model_name"
    android:layout_width="match_parent"
    android:layout_height="wrap_content"
    android:padding="16dp"
    android:textSize="16sp"
    android:textColor="@color/botdrop_primary_text"
    android:background="?attr/selectableItemBackground"
    android:clickable="true"
    android:focusable="true" />
```

### Step 3: Build to verify resources

Run: `./gradlew :app:processDebugResources`
Expected: SUCCESS

### Step 4: Commit

```bash
git add app/src/main/res/layout/dialog_model_selector.xml app/src/main/res/layout/item_model.xml
git commit -m "feat: add ModelSelectorDialog layout with search and list"
```

---

## Task 5: Create ModelListAdapter

**Files:**
- Create: `app/src/main/java/app/botdrop/ModelListAdapter.java`

**Goal:** RecyclerView adapter for model list with click handling.

### Step 1: Create ModelListAdapter.java

```java
package app.botdrop;

import android.view.LayoutInflater;
import android.view.View;
import android.view.ViewGroup;
import android.widget.TextView;

import androidx.annotation.NonNull;
import androidx.recyclerview.widget.RecyclerView;

import com.termux.R;

import java.util.ArrayList;
import java.util.List;

/**
 * RecyclerView adapter for model list.
 */
public class ModelListAdapter extends RecyclerView.Adapter<ModelListAdapter.ViewHolder> {

    private List<ModelInfo> mModels = new ArrayList<>();
    private OnModelClickListener mListener;

    public interface OnModelClickListener {
        void onModelClick(ModelInfo model);
    }

    public ModelListAdapter(OnModelClickListener listener) {
        this.mListener = listener;
    }

    public void updateList(List<ModelInfo> models) {
        this.mModels = models;
        notifyDataSetChanged();
    }

    @NonNull
    @Override
    public ViewHolder onCreateViewHolder(@NonNull ViewGroup parent, int viewType) {
        View view = LayoutInflater.from(parent.getContext())
            .inflate(R.layout.item_model, parent, false);
        return new ViewHolder(view);
    }

    @Override
    public void onBindViewHolder(@NonNull ViewHolder holder, int position) {
        ModelInfo model = mModels.get(position);
        holder.modelName.setText(model.fullName);
        holder.itemView.setOnClickListener(v -> {
            if (mListener != null) {
                mListener.onModelClick(model);
            }
        });
    }

    @Override
    public int getItemCount() {
        return mModels.size();
    }

    static class ViewHolder extends RecyclerView.ViewHolder {
        TextView modelName;

        ViewHolder(View itemView) {
            super(itemView);
            modelName = itemView.findViewById(R.id.model_name);
        }
    }
}
```

### Step 2: Build to verify

Run: `./gradlew :app:compileDebugJavaWithJavac`
Expected: SUCCESS

### Step 3: Commit

```bash
git add app/src/main/java/app/botdrop/ModelListAdapter.java
git commit -m "feat: add ModelListAdapter for RecyclerView"
```

---

## Task 6: Create ModelSelectorDialog (Part 1: Basic Structure)

**Files:**
- Create: `app/src/main/java/app/botdrop/ModelSelectorDialog.java`

**Goal:** Dialog class with UI setup and model loading logic.

### Step 1: Create ModelSelectorDialog.java skeleton

```java
package app.botdrop;

import android.app.Dialog;
import android.content.Context;
import android.os.Bundle;
import android.text.Editable;
import android.text.TextWatcher;
import android.view.View;
import android.view.Window;
import android.widget.Button;
import android.widget.EditText;
import android.widget.TextView;

import androidx.annotation.NonNull;
import androidx.recyclerview.widget.LinearLayoutManager;
import androidx.recyclerview.widget.RecyclerView;

import com.termux.R;
import com.termux.shared.logger.Logger;

import java.util.ArrayList;
import java.util.List;
import java.util.stream.Collectors;

/**
 * Dialog for selecting a model with search capability.
 * Fetches model list from openclaw models list command.
 */
public class ModelSelectorDialog extends Dialog {

    private static final String LOG_TAG = "ModelSelectorDialog";

    private BotDropService mService;
    private ModelSelectedCallback mCallback;

    private EditText mSearchBox;
    private RecyclerView mModelList;
    private TextView mStatusText;
    private Button mRetryButton;

    private ModelListAdapter mAdapter;
    private List<ModelInfo> mAllModels = new ArrayList<>();

    public interface ModelSelectedCallback {
        void onModelSelected(String provider, String model);
    }

    public ModelSelectorDialog(@NonNull Context context, BotDropService service) {
        super(context);
        this.mService = service;
    }

    public void show(ModelSelectedCallback callback) {
        this.mCallback = callback;
        super.show();
    }

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        requestWindowFeature(Window.FEATURE_NO_TITLE);
        setContentView(R.layout.dialog_model_selector);

        // Initialize views
        mSearchBox = findViewById(R.id.model_search);
        mModelList = findViewById(R.id.model_list);
        mStatusText = findViewById(R.id.model_status);
        mRetryButton = findViewById(R.id.model_retry);

        // Setup RecyclerView
        mAdapter = new ModelListAdapter(model -> {
            if (mCallback != null) {
                mCallback.onModelSelected(model.provider, model.model);
            }
            dismiss();
        });
        mModelList.setLayoutManager(new LinearLayoutManager(getContext()));
        mModelList.setAdapter(mAdapter);

        // Setup search
        mSearchBox.addTextChangedListener(new TextWatcher() {
            @Override
            public void beforeTextChanged(CharSequence s, int start, int count, int after) {}

            @Override
            public void onTextChanged(CharSequence s, int start, int before, int count) {
                filterModels(s.toString());
            }

            @Override
            public void afterTextChanged(Editable s) {}
        });

        // Setup retry button
        mRetryButton.setOnClickListener(v -> loadModels());

        // Load models
        loadModels();
    }

    private void loadModels() {
        showLoading();

        if (mService == null) {
            showError("Service not available");
            return;
        }

        // Execute openclaw models list command
        mService.executeCommand("termux-chroot openclaw models list", result -> {
            if (!result.success) {
                showError("Failed to load models. Please try again.");
                return;
            }

            // Parse models
            List<ModelInfo> models = parseModelList(result.stdout);

            if (models.isEmpty()) {
                showError("No models available.");
                return;
            }

            // Update UI
            mAllModels = models;
            mAdapter.updateList(models);
            showList();
        });
    }

    // Continued in next step...
}
```

### Step 2: Continue - Add parsing and UI state methods

Add to ModelSelectorDialog.java:

```java
    /**
     * Parse model list output from openclaw models list.
     * Format: "Model                                      Input      Ctx      Local Auth  Tags"
     *         "google/gemini-3-flash-preview              text+image 1024k    no    yes   default"
     */
    private List<ModelInfo> parseModelList(String output) {
        List<ModelInfo> models = new ArrayList<>();

        try {
            String[] lines = output.split("\n");

            for (String line : lines) {
                // Skip header and empty lines
                if (line.trim().isEmpty() || line.startsWith("Model ")) {
                    continue;
                }

                // Extract model name (first column before whitespace)
                String[] parts = line.trim().split("\\s+");
                if (parts.length > 0) {
                    String modelName = parts[0];
                    if (modelName.contains("/")) {
                        ModelInfo info = new ModelInfo(modelName);

                        // Parse additional fields if available
                        if (parts.length > 1) info.input = parts[1];
                        if (parts.length > 2) info.context = parts[2];

                        // Check for default tag
                        info.isDefault = line.contains("default");

                        models.add(info);
                    }
                }
            }

            Logger.logInfo(LOG_TAG, "Parsed " + models.size() + " models");

        } catch (Exception e) {
            Logger.logError(LOG_TAG, "Failed to parse model list: " + e.getMessage());
        }

        return models;
    }

    /**
     * Filter models based on search query.
     */
    private void filterModels(String query) {
        if (query == null || query.isEmpty()) {
            mAdapter.updateList(mAllModels);
            return;
        }

        String lowerQuery = query.toLowerCase();
        List<ModelInfo> filtered = mAllModels.stream()
            .filter(m -> m.fullName.toLowerCase().contains(lowerQuery))
            .collect(Collectors.toList());

        mAdapter.updateList(filtered);
    }

    /**
     * Show loading state.
     */
    private void showLoading() {
        mModelList.setVisibility(View.GONE);
        mRetryButton.setVisibility(View.GONE);
        mStatusText.setVisibility(View.VISIBLE);
        mStatusText.setText("Loading models...");
    }

    /**
     * Show error state.
     */
    private void showError(String message) {
        mModelList.setVisibility(View.GONE);
        mRetryButton.setVisibility(View.VISIBLE);
        mStatusText.setVisibility(View.VISIBLE);
        mStatusText.setText(message);
    }

    /**
     * Show list state.
     */
    private void showList() {
        mModelList.setVisibility(View.VISIBLE);
        mRetryButton.setVisibility(View.GONE);
        mStatusText.setVisibility(View.GONE);
    }
}
```

### Step 3: Build to verify

Run: `./gradlew :app:compileDebugJavaWithJavac`
Expected: SUCCESS

### Step 4: Commit

```bash
git add app/src/main/java/app/botdrop/ModelSelectorDialog.java
git commit -m "feat: add ModelSelectorDialog with parsing and search logic"
```

---

## Task 7: Add Force Check to UpdateChecker

**Files:**
- Modify: `app/src/main/java/app/botdrop/UpdateChecker.java`

**Goal:** Add forceCheck method that ignores 24-hour throttle.

### Step 1: Add forceCheck method

Add this method to UpdateChecker.java (after the existing `check` method):

```java
    /**
     * Force an immediate update check, ignoring the 24-hour throttle.
     * Used for manual update button.
     */
    public static void forceCheck(Context ctx, UpdateCallback cb) {
        SharedPreferences prefs = ctx.getSharedPreferences(PREFS_NAME, Context.MODE_PRIVATE);

        // Clear last check timestamp to bypass throttle
        prefs.edit().putLong(KEY_LAST_CHECK, 0).apply();

        Logger.logInfo(LOG_TAG, "Forcing update check (manual trigger)");

        // Execute normal check
        check(ctx, cb);
    }
```

### Step 2: Build to verify

Run: `./gradlew :app:compileDebugJavaWithJavac`
Expected: SUCCESS

### Step 3: Commit

```bash
git add app/src/main/java/app/botdrop/UpdateChecker.java
git commit -m "feat: add UpdateChecker.forceCheck for manual update button"
```

---

## Task 8: Add Manual Update Button to SetupActivity Layout

**Files:**
- Modify: `app/src/main/res/layout/activity_botdrop_setup.xml`

**Goal:** Add update button icon to navigation bar.

### Step 1: Create update icon drawable

Create: `app/src/main/res/drawable/ic_update.xml`

```xml
<?xml version="1.0" encoding="utf-8"?>
<vector xmlns:android="http://schemas.android.com/apk/res/android"
    android:width="24dp"
    android:height="24dp"
    android:viewportWidth="24"
    android:viewportHeight="24">
    <path
        android:fillColor="@color/botdrop_accent"
        android:pathData="M12,4V1L8,5l4,4V6c3.31,0 6,2.69 6,6 0,1.01 -0.25,1.97 -0.7,2.8l1.46,1.46C19.54,15.03 20,13.57 20,12c0,-4.42 -3.58,-8 -8,-8zm0,14c-3.31,0 -6,-2.69 -6,-6 0,-1.01 0.25,-1.97 0.7,-2.8L5.24,7.74C4.46,8.97 4,10.43 4,12c0,4.42 3.58,8 8,8v3l4,-4 -4,-4v3z"/>
</vector>
```

### Step 2: Modify activity_botdrop_setup.xml

Find the setup_navigation LinearLayout and add the update button:

```xml
    <LinearLayout
        android:id="@+id/setup_navigation"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:orientation="horizontal"
        android:padding="16dp"
        android:gravity="center_vertical"
        android:background="@color/botdrop_surface">

        <Button
            android:id="@+id/setup_button_back"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:text="Back"
            android:background="@drawable/botdrop_button_outline_bg"
            android:textColor="@color/botdrop_accent"
            android:paddingStart="24dp"
            android:paddingEnd="24dp"
            android:visibility="gone" />

        <!-- NEW: Manual update check button -->
        <ImageButton
            android:id="@+id/setup_check_updates"
            android:layout_width="48dp"
            android:layout_height="48dp"
            android:src="@drawable/ic_update"
            android:contentDescription="Check for updates"
            android:background="?attr/selectableItemBackgroundBorderless"
            android:padding="12dp"
            android:layout_marginStart="8dp" />

        <Space
            android:layout_width="0dp"
            android:layout_height="0dp"
            android:layout_weight="1" />

        <Button
            android:id="@+id/setup_button_next"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:text="Next"
            android:background="@drawable/botdrop_button_bg"
            android:textColor="@color/botdrop_background"
            android:paddingStart="24dp"
            android:paddingEnd="24dp"
            android:visibility="gone" />
    </LinearLayout>
```

### Step 3: Build to verify resources

Run: `./gradlew :app:processDebugResources`
Expected: SUCCESS

### Step 4: Commit

```bash
git add app/src/main/res/drawable/ic_update.xml app/src/main/res/layout/activity_botdrop_setup.xml
git commit -m "feat: add manual update button to SetupActivity navigation bar"
```

---

## Task 9: Wire Update Button in SetupActivity

**Files:**
- Modify: `app/src/main/java/app/botdrop/SetupActivity.java`

**Goal:** Connect update button click handler.

### Step 1: Add button initialization

In SetupActivity.onCreate(), after existing button setup, add:

```java
        // Setup manual update check button
        ImageButton checkUpdatesBtn = findViewById(R.id.setup_check_updates);
        checkUpdatesBtn.setOnClickListener(v -> {
            v.setEnabled(false);
            UpdateChecker.forceCheck(this, (version, url, notes) -> {
                v.setEnabled(true);
                if (version != null && !version.isEmpty()) {
                    // Show update available message
                    Toast.makeText(this, "Update available: v" + version, Toast.LENGTH_SHORT).show();
                    // Could show a dialog or banner here
                } else {
                    Toast.makeText(this, "No updates available", Toast.LENGTH_SHORT).show();
                }
            });
        });
```

### Step 2: Build to verify

Run: `./gradlew :app:compileDebugJavaWithJavac`
Expected: SUCCESS

### Step 3: Test on device/emulator

Run: `./gradlew installDebug`
- Open app in setup flow
- Click update button
- Should see toast message

### Step 4: Commit

```bash
git add app/src/main/java/app/botdrop/SetupActivity.java
git commit -m "feat: wire manual update check button in SetupActivity"
```

---

## Task 10: Integrate ModelSelectorDialog in AuthFragment

**Depends on:** Task 6

**Files:**
- Modify: `app/src/main/java/app/botdrop/AuthFragment.java`

**Goal:** Show model selector after provider selection, save to cache after verification.

### Step 1: Add fields to AuthFragment

Add these fields at the top of the class:

```java
    private String mSelectedModel; // Store selected model
```

### Step 2: Modify onProviderSelected

Find the `onProviderSelected` method and modify it to show model selector:

```java
    private void onProviderSelected(ProviderInfo provider) {
        mSelectedProvider = provider;
        Logger.logDebug(LOG_TAG, "Provider selected: " + provider.getId());

        // Show model selector dialog
        if (mService != null && mBound) {
            showModelSelector();
        } else {
            // Fallback: use default model
            String defaultModel = getDefaultModel(provider.getId());
            mSelectedModel = defaultModel;
            showAuthInput();
        }
    }

    private void showModelSelector() {
        ModelSelectorDialog dialog = new ModelSelectorDialog(requireContext(), mService);
        dialog.show((provider, model) -> {
            mSelectedModel = model;
            Logger.logDebug(LOG_TAG, "Model selected: " + provider + "/" + model);
            showAuthInput();
        });
    }
```

### Step 3: Modify verification success to save cache

Find where verification succeeds (in the verify button click handler or verification callback) and add cache save logic:

```java
    private void onVerifySuccess() {
        // Save to cache
        ConfigTemplate template = new ConfigTemplate();
        template.provider = mSelectedProvider.getId();
        template.model = mSelectedModel;
        template.apiKey = mInputField.getText().toString().trim();
        ConfigTemplateCache.saveTemplate(requireContext(), template);

        // Write OpenClaw config
        String model = mSelectedModel != null ? mSelectedModel : getDefaultModel(template.provider);
        boolean providerWritten = BotDropConfig.setProvider(template.provider, model);
        if (!providerWritten) {
            showStatus("Failed to write configuration", false);
            return;
        }

        boolean keyWritten = BotDropConfig.setApiKey(template.provider, template.apiKey);
        if (!keyWritten) {
            showStatus("Failed to save API key", false);
            return;
        }

        showStatus("✓ Connected!\nModel: " + template.provider + "/" + model, true);

        // Navigate to next step
        if (getActivity() instanceof SetupActivity) {
            ((SetupActivity) getActivity()).navigateToNextStep();
        }
    }
```

### Step 4: Build to verify

Run: `./gradlew :app:compileDebugJavaWithJavac`
Expected: SUCCESS

### Step 5: Commit

```bash
git add app/src/main/java/app/botdrop/AuthFragment.java
git commit -m "feat: integrate ModelSelectorDialog in AuthFragment"
```

---

## Task 11: Add Change Model UI to DashboardActivity Layout

**Files:**
- Modify: `app/src/main/res/layout/activity_botdrop_dashboard.xml`

**Goal:** Add current model display and change button.

### Step 1: Modify activity_botdrop_dashboard.xml

Add this section after the channels section:

```xml
    <!-- Current Model Section -->
    <TextView
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:text="Current Model"
        android:textSize="14sp"
        android:textColor="@color/botdrop_secondary_text"
        android:fontFamily="sans-serif-medium"
        android:layout_marginTop="24dp"
        android:layout_marginBottom="8dp" />

    <androidx.cardview.widget.CardView
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:layout_marginBottom="16dp"
        app:cardBackgroundColor="@color/botdrop_surface"
        app:cardCornerRadius="12dp"
        app:cardElevation="0dp">

        <LinearLayout
            android:layout_width="match_parent"
            android:layout_height="wrap_content"
            android:orientation="vertical"
            android:padding="16dp">

            <TextView
                android:id="@+id/current_model_text"
                android:layout_width="match_parent"
                android:layout_height="wrap_content"
                android:text="—"
                android:textSize="16sp"
                android:textColor="@color/botdrop_primary_text"
                android:fontFamily="monospace"
                android:layout_marginBottom="12dp" />

            <Button
                android:id="@+id/btn_change_model"
                android:layout_width="wrap_content"
                android:layout_height="wrap_content"
                android:text="Change Model"
                android:background="@drawable/botdrop_button_outline_bg"
                android:textColor="@color/botdrop_accent"
                android:paddingStart="16dp"
                android:paddingEnd="16dp" />
        </LinearLayout>
    </androidx.cardview.widget.CardView>
```

### Step 2: Build to verify resources

Run: `./gradlew :app:processDebugResources`
Expected: SUCCESS

### Step 3: Commit

```bash
git add app/src/main/res/layout/activity_botdrop_dashboard.xml
git commit -m "feat: add Change Model UI to DashboardActivity"
```

---

## Task 12: Wire Change Model in DashboardActivity

**Depends on:** Task 6, Task 11

**Files:**
- Modify: `app/src/main/java/app/botdrop/DashboardActivity.java`

**Goal:** Load current model, handle model change with dialog and gateway restart.

### Step 1: Add fields and initialize views

Add fields at the top of the class:

```java
    private TextView mCurrentModelText;
    private Button mChangeModelButton;
```

In onCreate(), after existing view initialization:

```java
        mCurrentModelText = findViewById(R.id.current_model_text);
        mChangeModelButton = findViewById(R.id.btn_change_model);

        mChangeModelButton.setOnClickListener(v -> onChangeModelClick());

        // Load current model
        loadCurrentModel();
```

### Step 2: Add loadCurrentModel method

```java
    private void loadCurrentModel() {
        try {
            JSONObject config = BotDropConfig.readConfig();
            if (config.has("agents")) {
                JSONObject agents = config.getJSONObject("agents");
                if (agents.has("defaults")) {
                    JSONObject defaults = agents.getJSONObject("defaults");
                    if (defaults.has("model")) {
                        JSONObject modelObj = defaults.getJSONObject("model");
                        if (modelObj.has("primary")) {
                            String model = modelObj.getString("primary");
                            mCurrentModelText.setText(model);
                            return;
                        }
                    }
                }
            }
        } catch (Exception e) {
            Logger.logError(LOG_TAG, "Failed to load current model: " + e.getMessage());
        }
        mCurrentModelText.setText("—");
    }
```

### Step 3: Add onChangeModelClick method

```java
    private void onChangeModelClick() {
        if (!mBound || mBotDropService == null) {
            Toast.makeText(this, "Service not available", Toast.LENGTH_SHORT).show();
            return;
        }

        ModelSelectorDialog dialog = new ModelSelectorDialog(this, mBotDropService);
        dialog.show((provider, model) -> {
            String fullModel = provider + "/" + model;
            Logger.logInfo(LOG_TAG, "Changing model to: " + fullModel);

            // Update config
            if (updateModelConfig(fullModel)) {
                // Update cache
                updateModelCache(fullModel);

                // Update UI
                mCurrentModelText.setText(fullModel);

                // Restart gateway
                Toast.makeText(this, "Model changed, restarting gateway...", Toast.LENGTH_SHORT).show();
                restartGateway();
            } else {
                Toast.makeText(this, "Failed to update model", Toast.LENGTH_SHORT).show();
            }
        });
    }
```

### Step 4: Add helper methods

```java
    private boolean updateModelConfig(String fullModel) {
        try {
            JSONObject config = BotDropConfig.readConfig();

            // Ensure structure exists
            if (!config.has("agents")) {
                config.put("agents", new JSONObject());
            }
            JSONObject agents = config.getJSONObject("agents");

            if (!agents.has("defaults")) {
                agents.put("defaults", new JSONObject());
            }
            JSONObject defaults = agents.getJSONObject("defaults");

            if (!defaults.has("model")) {
                defaults.put("model", new JSONObject());
            }
            JSONObject modelObj = defaults.getJSONObject("model");

            // Update model
            modelObj.put("primary", fullModel);

            // Write config
            return BotDropConfig.writeConfig(config);

        } catch (Exception e) {
            Logger.logError(LOG_TAG, "Failed to update model config: " + e.getMessage());
            return false;
        }
    }

    private void updateModelCache(String fullModel) {
        try {
            ConfigTemplate template = ConfigTemplateCache.loadTemplate(this);
            if (template != null) {
                template.model = fullModel;
                ConfigTemplateCache.saveTemplate(this, template);
            }
        } catch (Exception e) {
            Logger.logError(LOG_TAG, "Failed to update cache: " + e.getMessage());
        }
    }
```

### Step 5: Build to verify

Run: `./gradlew :app:compileDebugJavaWithJavac`
Expected: SUCCESS

### Step 6: Commit

```bash
git add app/src/main/java/app/botdrop/DashboardActivity.java
git commit -m "feat: wire Change Model functionality in DashboardActivity"
```

---

## Task 13: Save Telegram Config to Cache in ChannelFragment

**Files:**
- Modify: `app/src/main/java/app/botdrop/ChannelFragment.java`

**Goal:** Update cache when Telegram channel is configured.

### Step 1: Find Telegram configuration success

Find where Telegram channel is successfully configured (likely in a method called after bot token and user ID are validated).

### Step 2: Add cache update

Add this code after successful Telegram configuration:

```java
    // Update cache with Telegram info
    try {
        ConfigTemplate template = ConfigTemplateCache.loadTemplate(requireContext());
        if (template == null) {
            template = new ConfigTemplate();
        }
        template.tgBotToken = botToken;
        template.tgUserId = userId;
        ConfigTemplateCache.saveTemplate(requireContext(), template);

        Logger.logInfo(LOG_TAG, "Telegram config saved to cache");
    } catch (Exception e) {
        Logger.logError(LOG_TAG, "Failed to save Telegram to cache: " + e.getMessage());
    }
```

### Step 3: Build to verify

Run: `./gradlew :app:compileDebugJavaWithJavac`
Expected: SUCCESS

### Step 4: Commit

```bash
git add app/src/main/java/app/botdrop/ChannelFragment.java
git commit -m "feat: save Telegram config to cache in ChannelFragment"
```

---

## Task 14: Add Config Restore Dialog in SetupActivity

**Depends on:** Task 2

**Files:**
- Modify: `app/src/main/java/app/botdrop/SetupActivity.java`

**Goal:** Check for cached config on startup, offer to restore.

### Step 1: Add check in onCreate

In SetupActivity.onCreate(), after existing initialization, add:

```java
        // Check for cached config
        if (ConfigTemplateCache.hasTemplate(this)) {
            showRestoreConfigDialog();
        }
```

### Step 2: Add showRestoreConfigDialog method

```java
    private void showRestoreConfigDialog() {
        new androidx.appcompat.app.AlertDialog.Builder(this)
            .setTitle("Restore Configuration?")
            .setMessage("Use your previous configuration to set up quickly.")
            .setPositiveButton("Use Previous", (dialog, which) -> {
                applyTemplateAndContinue();
            })
            .setNegativeButton("Start Fresh", (dialog, which) -> {
                // User chooses to start fresh, do nothing
                dialog.dismiss();
            })
            .setCancelable(false)
            .show();
    }
```

### Step 3: Add applyTemplateAndContinue method

```java
    private void applyTemplateAndContinue() {
        ConfigTemplate template = ConfigTemplateCache.loadTemplate(this);

        if (template == null || !template.isValid()) {
            Toast.makeText(this, "Failed to load previous config", Toast.LENGTH_SHORT).show();
            return;
        }

        // Apply template
        boolean success = ConfigTemplateCache.applyTemplate(this, template);

        if (!success) {
            Toast.makeText(this, "Failed to apply config", Toast.LENGTH_SHORT).show();
            return;
        }

        Toast.makeText(this, "Configuration restored", Toast.LENGTH_SHORT).show();

        // Determine which step to jump to
        if (template.tgBotToken != null && !template.tgBotToken.isEmpty()) {
            // Telegram configured, go to final step or dashboard
            finish();
            Intent intent = new Intent(this, DashboardActivity.class);
            startActivity(intent);
        } else {
            // Need to configure channel
            mViewPager.setCurrentItem(STEP_CHANNEL);
        }
    }
```

### Step 4: Build to verify

Run: `./gradlew :app:compileDebugJavaWithJavac`
Expected: SUCCESS

### Step 5: Commit

```bash
git add app/src/main/java/app/botdrop/SetupActivity.java
git commit -m "feat: add config restore dialog in SetupActivity"
```

---

## Task 15: Integration Testing

**Depends on:** All previous tasks

**Goal:** Test all features end-to-end.

### Step 1: Build debug APK

Run: `./gradlew assembleDebug`
Expected: SUCCESS

### Step 2: Install on device

Run: `./gradlew installDebug`
Expected: APK installed

### Step 3: Test Manual Update Button

1. Open app in setup flow
2. Click update icon button in navigation bar
3. Should see toast: "No updates available" or update info
4. Verify button re-enables after check

### Step 4: Test Model Selector in Auth Flow

1. Complete setup to Auth step
2. Select a provider (e.g., Google)
3. Model selector dialog should appear
4. Type in search box, verify filtering works
5. Select a model
6. Continue with API key input
7. After verification, check that config is saved to cache

### Step 5: Test Config Cache

1. After completing setup with auth
2. Clear OpenClaw config: `rm ~/.openclaw/openclaw.json`
3. Restart app
4. Should see "Restore Configuration?" dialog
5. Click "Use Previous"
6. Verify config is restored

### Step 6: Test Model Change in Dashboard

1. Open Dashboard
2. Verify current model is displayed
3. Click "Change Model"
4. Model selector appears
5. Select different model
6. Verify model updates and gateway restarts
7. Check cache is updated

### Step 7: Test Error Scenarios

1. Model selector when OpenClaw not installed
2. Model selector with invalid output
3. Config restore with corrupted cache
4. Update check with network offline

### Step 8: Document test results

Create test results summary:

```bash
echo "# v0.2.2 Integration Test Results" > test-results.txt
echo "Date: $(date)" >> test-results.txt
echo "" >> test-results.txt
echo "## Manual Update Button" >> test-results.txt
echo "- [ ] Button visible in SetupActivity" >> test-results.txt
echo "- [ ] Click triggers force check" >> test-results.txt
echo "- [ ] Shows appropriate message" >> test-results.txt
echo "" >> test-results.txt
echo "## Model Selector" >> test-results.txt
echo "- [ ] Dialog shows in Auth flow" >> test-results.txt
echo "- [ ] Search filtering works" >> test-results.txt
echo "- [ ] Model selection updates config" >> test-results.txt
echo "- [ ] Dialog shows in Dashboard" >> test-results.txt
echo "" >> test-results.txt
echo "## Config Cache" >> test-results.txt
echo "- [ ] Config saved after auth" >> test-results.txt
echo "- [ ] Restore dialog shown on restart" >> test-results.txt
echo "- [ ] Config applied successfully" >> test-results.txt
echo "- [ ] Telegram info cached" >> test-results.txt
echo "" >> test-results.txt
echo "## Error Handling" >> test-results.txt
echo "- [ ] Model selector handles failures gracefully" >> test-results.txt
echo "- [ ] Config cache handles corruption" >> test-results.txt
echo "- [ ] Update check handles network errors" >> test-results.txt
```

### Step 9: Commit test results

```bash
git add test-results.txt
git commit -m "test: integration testing results for v0.2.2 features"
```

---

## Task 16: Final Code Review and Cleanup

**Goal:** Review all changes, ensure code quality, and prepare for release.

### Step 1: Review code style and consistency

Check:
- [ ] Consistent naming conventions
- [ ] Proper error handling in all methods
- [ ] Logging statements appropriate
- [ ] Comments clear and helpful
- [ ] No debug code left in

### Step 2: Check for memory leaks

Verify:
- [ ] Dialog dismissal clears references
- [ ] Callbacks don't hold Activity references
- [ ] Service connections properly unbound

### Step 3: Verify resource IDs

Check:
- [ ] No duplicate resource IDs
- [ ] All strings extracted to resources (if applicable)
- [ ] Drawables properly referenced

### Step 4: Update version in build.gradle

Verify `app/build.gradle`:
```gradle
versionCode 4
versionName "0.2.2"
```

### Step 5: Run final build

Run: `./gradlew clean assembleDebug`
Expected: SUCCESS with no warnings

### Step 6: Create summary commit

```bash
git add -A
git commit -m "chore: v0.2.2 final cleanup and polish

- Code review complete
- All tests passing
- Version bumped to 0.2.2
- Ready for release"
```

---

## Summary

**Completed Components:**
1. ✅ ConfigTemplate & ConfigTemplateCache - Configuration caching
2. ✅ ModelInfo & ModelSelectorDialog - Dynamic model selection
3. ✅ ModelListAdapter - RecyclerView adapter
4. ✅ UpdateChecker.forceCheck() - Manual update trigger
5. ✅ Manual update button UI and wiring
6. ✅ AuthFragment integration
7. ✅ DashboardActivity integration
8. ✅ ChannelFragment integration
9. ✅ Config restore dialog

**Total Commits:** ~16 commits

**Estimated Time:** 5-6 hours

**Next Steps:**
- Create release build
- Test on multiple devices
- Prepare release notes
- Tag release: v0.2.2

---

_Plan created: 2026-02-09_
_Ready for execution_
